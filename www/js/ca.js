/*
 * ca.js
 * https://github.com/after12am/cell-automata
 *
 * Copyright 2012 Satoshi Okami
 * Released under the MIT license
 */
var ca=function(){function o(a){return{_:a,loadContentsOf:function(a){this._.loadContentsOf(a)},destroy:function(){this._.destroy()}}}function q(a){return o(m.fromElement(a))}function r(d,c){var b=a.getExtension("OES_texture_float")?a.FLOAT:a.UNSIGNED_BYTE;this._.texture&&this._.texture.destroy();this._.spareTexture&&this._.spareTexture.destroy();this.width=d;this.height=c;this._.texture=new m(d,c,a.RGBA,b);this._.spareTexture=new m(d,c,a.RGBA,b);this._.extraTexture=this._.extraTexture||new m(0,0,
a.RGBA,b);this._.flippedShader=this._.flippedShader||new n(null,"uniform sampler2D texture;varying vec2 texCoord;void main(){gl_FragColor=texture2D(texture,vec2(texCoord.x,1.0-texCoord.y));}");this._.isInitialized=!0}function s(a,c,b){if(!this._.isInitialized||a._.width!=this.width||a._.height!=this.height)r.call(this,c?c:a._.width,b?b:a._.height);a._.use();this._.texture.drawTo(function(){n.getDefaultShader().drawRect()});return this}function t(){this._.texture.use();
this._.flippedShader.drawRect();return this}function u(a){a.parentNode.insertBefore(this,a);a.parentNode.removeChild(a);return this}function v(){var d=new m(this._.texture.width,this._.texture.height,a.RGBA,a.UNSIGNED_BYTE);this._.texture.use();d.drawTo(function(){n.getDefaultShader().drawRect()});return o(d)}function p(){var d=this._.texture.width,c=this._.texture.height,b=new Uint8Array(4*d*c);this._.texture.drawTo(function(){a.readPixels(0,0,d,c,a.RGBA,a.UNSIGNED_BYTE,b)});return b}function w(a){var c=
this._.texture.width,b=this._.texture.height,f=p.call(this),i=document.createElement("canvas"),e=i.getContext("2d");i.width=c;i.height=b;c=e.createImageData(c,b);for(b=0;b<f.length;b++)c.data[b]=f[b];e.putImageData(c,0,0);return i.toDataURL(a)}function l(d){return function(){a=this._.gl;return d.apply(this,arguments)}}var g={Automata:function(a,c,b){this.width=c;this.height=b;this.rule=a;this.steps=0;this.canvas=ca.canvas();this.texture=this.canvas.texture(function(){var a=new Image;a.width=c;a.height=
b;return a}());this.canvas.draw(this.texture);this.pixels=this.canvas.getPixelArray()}};g.Automata.prototype.set=function(a,c,b){a=4*(a+c*this.width);b=0==b?0:255;this.pixels[a]=b;this.pixels[a+1]=b;this.pixels[a+2]=b;this.pixels[a+3]=255};g.Automata.prototype.get=function(a,c){return this.pixels[4*(a+c*this.width)]/255};g.Automata.prototype.completed=function(){console.warn("termination condition is not defined. please define termination condition for performance by overriding");return!1};g.Automata.prototype.proceed=
function(){this.rule.proceed(this);a.bindTexture(a.TEXTURE_2D,this.texture._.id);a.texImage2D(a.TEXTURE_2D,0,this.canvas._.gl.RGBA,this.width,this.height,0,this.canvas._.gl.RGBA,this.canvas._.gl.UNSIGNED_BYTE,this.pixels);this.canvas.draw(this.texture).update();this.steps++};g.dec2bin=function(a){return parseInt(a).toString(2)};g.dec2binAsArr=function(a,c){return g.str2arr(g.dec2bin(a),c)};g.str2arr=function(a,c){if(!c)throw Error("digits is not defined");for(var b=[],f=0;f<c-a.length;f++)b.push(0);
for(f in a)b.push(parseInt(a[f]));return b};g.Rule2x3=function(a){this.rules=g.dec2binAsArr(a||0,8);this.matrix=[1,3]};g.Rule2x3.prototype.proceed=function(a){if(0!=a.steps)for(var c=a.width,b=this.rules,f=1;f<c-1;f++){for(var i=2,e=0,h=f-1;h<=f+1;h++)e+=a.get(h,a.steps-1)*Math.pow(2,i),i--;a.set(f,a.steps,b[b.length-e-1])}};g.Rule2x5=function(a){var a=a||0,c=Math.pow(2,5);this.rules=g.dec2binAsArr(a,c);this.matrix=[2,3]};g.Rule2x5.prototype.proceed=function(a){if(0!=a.steps)for(var c=a.width,b=this.rules,
f=1;f<c-1;f++){for(var i=4,e=0,h=a.steps;h>=a.steps-1;h--)for(var j=f-1;j<=f+1;j++)j==f&&h==a.steps||(e+=a.get(j,h)*Math.pow(2,i),i--);a.set(f,a.steps,b[b.length-e-1])}};g.Rule3x3=function(){this.rules=[];this.matrix=[3,3]};g.Rule3x3.prototype.proceed=function(a){function c(a,i,e){a=4*(a+i*f);e=0==e?0:255;b[a]=e;b[a+1]=e;b[a+2]=e;b[a+3]=255}for(var b=new Uint8Array(a.pixels.length),f=a.width,i=a.height,e=0;e<f;e++)for(var h=0;h<i;h++){for(var j=0,k=e-1;k<=e+1;k++)for(var g=h-1;g<=h+1;g++)k==e&&g==
h||a.get(k,g)&&j++;if(k=a.get(e,h)){if(1>=j){c(e,h,0);continue}if(2==j||3==j){c(e,h,1);continue}if(4<=j){c(e,h,0);continue}}!k&&3==j&&c(e,h,1)}a.pixels=b};var a;g.canvas=function(){var d=document.createElement("canvas");try{a=d.getContext("experimental-webgl",{premultipliedAlpha:!1})}catch(c){a=null}if(!a)throw"This browser does not support WebGL";d._={gl:a,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null};d.texture=l(q);d.draw=l(s);d.update=l(t);d.replace=l(u);d.contents=l(v);d.getPixelArray=
l(p);d.toDataURL=l(w);return d};var n=function(){function d(f,e){var b=a.createShader(f);a.shaderSource(b,e);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS))throw"compile error: "+a.getShaderInfoLog(b);return b}function c(i,e){this.texCoordAttribute=this.vertexAttribute=null;this.program=a.createProgram();i=i||b;e=e||f;e="precision highp float;"+e;a.attachShader(this.program,d(a.VERTEX_SHADER,i));a.attachShader(this.program,d(a.FRAGMENT_SHADER,e));a.linkProgram(this.program);if(!a.getProgramParameter(this.program,
a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program);}var b="attribute vec2 vertex;attribute vec2 _texCoord;varying vec2 texCoord;void main(){texCoord=_texCoord;gl_Position=vec4(vertex*2.0-1.0,0.0,1.0);}",f="uniform sampler2D texture;varying vec2 texCoord;void main(){gl_FragColor=texture2D(texture,texCoord);}";c.prototype.destroy=function(){a.deleteProgram(this.program);this.program=null};c.prototype.uniforms=
function(f){a.useProgram(this.program);for(var e in f)if(f.hasOwnProperty(e)){var b=a.getUniformLocation(this.program,e);if(null!==b){var c=f[e];if("[object Array]"==Object.prototype.toString.call(c))switch(c.length){case 1:a.uniform1fv(b,new Float32Array(c));break;case 2:a.uniform2fv(b,new Float32Array(c));break;case 3:a.uniform3fv(b,new Float32Array(c));break;case 4:a.uniform4fv(b,new Float32Array(c));break;case 9:a.uniformMatrix3fv(b,!1,new Float32Array(c));break;case 16:a.uniformMatrix4fv(b,!1,
new Float32Array(c));break;default:throw"dont't know how to load uniform \""+e+'" of length '+c.length;}else if("[object Number]"==Object.prototype.toString.call(c))a.uniform1f(b,c);else throw'attempted to set uniform "'+e+'" to invalid value '+(c||"undefined").toString();}}return this};c.prototype.textures=function(f){a.useProgram(this.program);for(var b in f)f.hasOwnProperty(b)&&a.uniform1i(a.getUniformLocation(this.program,b),f[b]);return this};c.prototype.drawRect=function(f,b,c,d){var g=a.getParameter(a.VIEWPORT),
b=void 0!==b?(b-g[1])/g[3]:0,f=void 0!==f?(f-g[0])/g[2]:0,c=void 0!==c?(c-g[0])/g[2]:1,d=void 0!==d?(d-g[1])/g[3]:1;null==a.vertexBuffer&&(a.vertexBuffer=a.createBuffer());a.bindBuffer(a.ARRAY_BUFFER,a.vertexBuffer);a.bufferData(a.ARRAY_BUFFER,new Float32Array([f,b,f,d,c,b,c,d]),a.STATIC_DRAW);null==a.texCoordBuffer&&(a.texCoordBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,a.texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),a.STATIC_DRAW));null==this.vertexAttribute&&
(this.vertexAttribute=a.getAttribLocation(this.program,"vertex"),a.enableVertexAttribArray(this.vertexAttribute));null==this.texCoordAttribute&&(this.texCoordAttribute=a.getAttribLocation(this.program,"_texCoord"),a.enableVertexAttribArray(this.texCoordAttribute));a.useProgram(this.program);a.bindBuffer(a.ARRAY_BUFFER,a.vertexBuffer);a.vertexAttribPointer(this.vertexAttribute,2,a.FLOAT,!1,0,0);a.bindBuffer(a.ARRAY_BUFFER,a.texCoordBuffer);a.vertexAttribPointer(this.texCoordAttribute,2,a.FLOAT,!1,
0,0);a.drawArrays(a.TRIANGLE_STRIP,0,4)};c.getDefaultShader=function(){a.defaultShader=a.defaultShader||new c;return a.defaultShader};return c}(),m=function(){function d(f,b,c,d){this.id=a.createTexture();this.width=f;this.height=b;this.format=c;this.type=d;a.bindTexture(a.TEXTURE_2D,this.id);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);f&&b&&a.texImage2D(a.TEXTURE_2D,0,this.format,f,b,0,this.format,this.type,null)}function c(a){null==b&&(b=document.createElement("canvas"));b.width=a.width;b.height=a.height;a=b.getContext("2d");a.clearRect(0,0,b.width,b.height);return a}d.fromElement=function(b){var c=new d(0,0,a.RGBA,a.UNSIGNED_BYTE);c.loadContentsOf(b);return c};d.prototype.loadContentsOf=function(b){this.width=b.width||b.videoWidth;this.height=b.height||b.videoHeight;a.bindTexture(a.TEXTURE_2D,
this.id);a.texImage2D(a.TEXTURE_2D,0,this.format,this.format,this.type,b)};d.prototype.initFromBytes=function(b,c,e){this.width=b;this.height=c;this.format=a.RGBA;this.type=a.UNSIGNED_BYTE;a.bindTexture(a.TEXTURE_2D,this.id);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,this.type,new Uint8Array(e))};d.prototype.destroy=function(){a.deleteTexture(this.id);this.id=null};d.prototype.use=function(b){a.activeTexture(a.TEXTURE0+(b||0));a.bindTexture(a.TEXTURE_2D,this.id)};d.prototype.unuse=function(b){a.activeTexture(a.TEXTURE0+
(b||0));a.bindTexture(a.TEXTURE_2D,null)};d.prototype.ensureFormat=function(b,c,e,d){if(1==arguments.length)var g=arguments[0],b=g.width,c=g.height,e=g.format,d=g.type;if(b!=this.width||c!=this.height||e!=this.format||d!=this.type)this.width=b,this.height=c,this.format=e,this.type=d,a.bindTexture(a.TEXTURE_2D,this.id),a.texImage2D(a.TEXTURE_2D,0,this.format,b,c,0,this.format,this.type,null)};d.prototype.drawTo=function(b){a.framebuffer=a.framebuffer||a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,
a.framebuffer);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.id,0);a.viewport(0,0,this.width,this.height);b();a.bindFramebuffer(a.FRAMEBUFFER,null)};var b=null;d.prototype.fillUsingCanvas=function(f){f(c(this));this.format=a.RGBA;this.type=a.UNSIGNED_BYTE;a.bindTexture(a.TEXTURE_2D,this.id);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);return this};d.prototype.toImage=function(f){this.use();n.getDefaultShader().drawRect();var d=4*this.width*this.height,
e=new Uint8Array(d),g=c(this),j=g.createImageData(this.width,this.height);a.readPixels(0,0,this.width,this.height,a.RGBA,a.UNSIGNED_BYTE,e);for(var k=0;k<d;k++)j.data[k]=e[k];g.putImageData(j,0,0);f.src=b.toDataURL()};d.prototype.swapWith=function(a){var b;b=a.id;a.id=this.id;this.id=b;b=a.width;a.width=this.width;this.width=b;b=a.height;a.height=this.height;this.height=b;b=a.format;a.format=this.format;this.format=b};return d}();return g}();
